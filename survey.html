<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="question-mc.html">
<link rel="import" href="question-ft.html">
<link rel="import" href="question-ne.html">
<!--
An element providing a solution to no problem in particular.

Example:

    <seed-element></seed-element>

@demo
-->
<dom-module id="survey-a">

  <style is="custom-style">
    :host {
      display: block;
      box-sizing: border-box;
    }
    paper-icon-item {
      @apply(--paper-font-body2)
      margin-bottom: 4px;
      border-bottom: 1px solid gray;
    }
    .survey-hdr {
      @apply(--layout-horizontal);
      @apply(--layout-flex);
      @apply(--paper-font-title)
    }
    .hdr-left {
      @apply(--layout-flex-4);
    }
    .hdr-right {
      @apply(--layout-flex-8);
      text-align: right;
    }
    paper-button {
      @apply(--paper-font-button);
    }
    .display_num {
      @apply(--paper-font-body2)
      text-align: right;
    }
    .survey-title {
      @apply(--paper-font-title)
    }
    .survey-subhead{
      @apply(--paper-font-subhead)
    }
    .card-actions {
      border-bottom: 1px solid lightgrey;
    }

    /* answer sheet */
    .list {
      @apply(--layout-vertical);
      padding-top: 12px;
      background-color: white;
      width: 240px;
      height: 228px;
      margin: 12px;
      @apply(--shadow-elevation-2dp);
    } 

    .avatar {
      display: inline-block;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      background: #ccc;
    }

    .blue {
      background-color: var(--paper-light-blue-300);
    }

    .red {
      background-color: var(--paper-red-300);
    }

    .orange {
      background-color: var(--paper-amber-300);
    }

    .green {
      background-color: var(--paper-green-300);
    }


  </style>

  <template>
    <div class="survey-hdr">
      <div class="hdr-left">
        <div class='survey-title'>[[title]]</div>
        <div class='survey-subhead'>[[subhead]]</div>
      </div>
      <div class="hdr-right">
        <div>[[summary_txt]]</div>
        <div>
          <paper-button on-click="previewAnswers">Preview Answers</paper-button>
        </div>
      </div>
    </div>
    <div id="qlist">
      <!--the container for our question components, dynamically inserted-->
    </div>
    <paper-dialog id="answerSheetDialog">
      <paper-dialog-scrollable>
        <h2>Answers:</h2>
        <template 
          is="dom-repeat"
          items="[[answers]]"
          as="answer"
        </template>
          <paper-icon-item>
            <div class="" item-icon>
              [[answer.qnum]]
            </div>
            <paper-item-body two-line>
              <div>[[answer.q]]</div>
              <div secondary>[[answer.a]]</div>
            </paper-item-body>
          </paper-icon-item>
        </template>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Dismiss</paper-button>
      </div>
    </paper-dialog>
    <iron-ajax
      id="ajaxer"       
      handle-as="json",
      on-response="survey_loaded",
    >
    </iron-ajax>
  </template>

</dom-module>

<script>
  var QSTATE = [
  "Pristine",
  "InProgress",
  "Complete",
  "Marked as NA"
  ];

  Polymer({

    is: 'survey-a',

    properties: {

      patient_id: {
        type: String,
        value: function(){ return "Missing Patient ID"; }
      },

      title: {
        type: String,
        value: function(){ return "Missing Surve Title?"; }
      },

      subhead: {
        type: String,
        value: function(){ return "Missing Survey Subheading"; }
      },
      testsib: {
        type: String,
        value: "INIT"
      },
      summary_txt: {
        type: String,
        value: ""
      }
     
    },

    ready: function(){
      var self = this;
      this.start();
    },

    start: function(){ 
      this.$.ajaxer.url="../sample_survey.json";
      this.$.ajaxer.generateRequest();

      return;
    },

    _convert_yn_to_mc: function(q){
      q.minmax=[1,1];
      q.kind="mc";
      q.opts = [
        { txt: "YES" },
        { txt: "NO" }
      ];
      if ( q.rule ){
        if ( q.rule.y ){
          for(var k in q.rule.y)
            q.opts[0][k] = q.rule.y[k];
        }
        if ( q.rule.n ){
          for(var k in q.rule.n)
            q.opts[1][k] = q.rule.n[k];
        }
      }
      return q;
    },

    survey_loaded: function(event){
      var survey_data = event.detail.response;
      this.questions = {};
      var self = this;
      this.questions_n = survey_data.length;
      survey_data.forEach(function(q,idx){
        if ( ["mc","ft","ne","yn"].indexOf( q.kind ) === -1 ) return;

        q.display_num = "Q"+ q._id;

        if ( q.kind=="yn" ){
          q = self._convert_yn_to_mc(q);
        }


        var qtype = "Question"+q.kind.toUpperCase();
        var new_q = new window[qtype](q);


        self.listen(new_q,"siblingdisplay-changed","hideOrRevealSiblings");
        self.listen(new_q,"qstate-changed","qstateChanged");
        Polymer.dom(self.$.qlist).appendChild(new_q);

        if ( q.hidden ) {
          var tg = new_q.querySelector("question-part-hdr");
          new_q.toggleClass("hilite-qhdr-bg",true, tg );
        }

        self.questions[q._id.toString()] = new_q;
        return;
      });
      this.summarize();
    },
  
    _build_answer_sheet: function(q){
      var self = this;
      if (q.qstate===3) var a= "N/A";
      else if (q.qstate===0) var a= "Incomplete";
      else switch(q.kind){
        case "ft":
        case "ne":
          a= q.answer;
          break;
        case "mc":
          a =[];
          q.answer.forEach(function(ans){
            a.push( q.opts[ans].txt );
          });
          a = a.join(",");
          break;
      }
      var r = {
        qnum: q.display_num,
        q: q.txt,
        a: a
      };
      console.log(r);
      return r;
    },

    previewAnswers: function(){
      this.$.answerSheetDialog.open();
    },

    summarize: function(){
      var qstate_counts = [ 0, 0, 0, 0];
      var count_hidden = 0;
      var answers = [];
      for(var qnum in this.questions){
        if(this.questions[ qnum ].hidden){ 
          count_hidden++;
        }
        else{
          qstate_counts[ this.questions[qnum].qstate ]++;
          answers.push( this._build_answer_sheet(this.questions[qnum]) );
        }
      }
      console.log(qstate_counts);
      qstate_counts = qstate_counts;
      count_hidden = count_hidden;
      this.summary_txt = [
        "Total Required:", 
        (this.questions_n - count_hidden),
        " Complete:",
        qstate_counts[2],
        " NA:",
        qstate_counts[3]
      ].join(" ");

      console.log(this.summary_txt);
      this.answers = answers;
    },

    hideOrRevealSiblings: function(e){
      //console.log("siblingscheck",e.detail.value);
      var self = this;
      e.detail.value.hide.forEach(function(qnum){
        self.questions[qnum.toString()].hidden=true;
      });
      e.detail.value.reveal.forEach(function(qnum){
        self.questions[qnum.toString()].hidden=false;
      });
    },

    qstateChanged: function(e){
      //doesn't matter which question changed, just so we know to update the summary
      this.summarize();

    }

  });

</script>
