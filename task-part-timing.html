<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../moment-display/moment-import.html">
<link rel="import" href="../moment-display/moment-display.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-date-picker/paper-date-picker.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <seed-element></seed-element>

@demo
-->
<dom-module id="task-part-timing">
  <style is="custom-style">

    .main { 
      padding: 4px;
    }
    .flexchild {
      @apply(--layout-flex);
    }
    .displaytxt {
      cursor: pointer;
      text-align: right;
      margin: 4px;
    }
      

</style>

  <template>


    <div class="main">
      <div class="displaytxt">
        <strong
         title="Task has no schedule date."
         hidden="[[!isAsap]]"
         on-click="openDatePicker"
         >
         ASAP
       </strong>

        <strong
         hidden="[[!isPlannedPast]]"
         title="Task is OVERDUE."
         on-click="openDatePicker"
        >
          OVERDUE
        </strong>

        <strong
         hidden="[[!isPlannedFuture]]"
         title="Task is scheduled for a future date."
         on-click="openDatePicker"
        >
          Planned For 
        </strong>


        <strong
         hidden="[[!isPlannedCurrent]]"
         title="Task is Current."
         on-click="openDatePicker"
        >
          Planned For
        </strong>

        <moment-display
          hidden="[[!plannedFor.start]]"
          dt="[[plannedFor.start]]"
          on-click="openDatePicker"
        >
        </moment-display>

        <strong
          hidden="[[!mustSchedule]]" 
          on-click="openDatePicker" 
          title="Task is unscheduled but scheduling is required. Click to schedule"
        >
          Schedule It
        </strong>

        <!--<span>Test: [[selectedStartDate]]</span>-->
        <iron-icon icon="perm-contact-calendar"></iron-icon>
      </div>
    </div>


    <!--- DATEPICKER MODAL CONTENT -->
    <paper-dialog 
      id="dialog" class="paper-date-picker-dialog" modal
      on-iron-overlay-closed="gotDismissDialog"
    >
      <paper-date-picker id="picker" date="{{selectedStartDate}}" >
      </paper-date-picker>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>OK</paper-button>
      </div>
    </paper-dialog>


  </template>

</dom-module>

<script>
  var QSTATE = [
    "Pristine",
    "InProgress",
    "Complete",
    "Marked as NA"
  ];

  Polymer({

    is: 'task-part-timing',

    properties: {
      taskId: {
        type: String
      },
      taskTs: {
        type: String,
        notify: true
      },
      plannedFor: {
        type: Object,
        value: null,
        notify: true
      },
      taskState: {
        type: Object,
        value: null
      },
      okToStartTask: { type: Boolean, value: false , notify: true },
      isAsap: { type: Boolean, value: false },
      mustSchedule: { type: Boolean, value: false },
      plannedPast: { type: Boolean, value: false },
      plannedCurrent: { type: Boolean, value: false },
      plannedFuture: { type: Boolean, value: false }

    },

    attached: function(){

      //console.log(this.plannedFor.kind, this.selectedStartDate, this.plannedFor.start);
      this._lastSaved = _.clone(this.plannedFor);
      this._evaluate();
    },

    openDatePicker: function(){
      if ( this.taskState==="done" ) {
        app.$.toast.text="You can not (re)schedule completed tasks";
        app.$.toast.show();
        return;
      }
      this.$.dialog.open();
    },

    gotDismissDialog:function(closeEvent){

      if ( closeEvent.detail.confirmed !== true ){
        
        return;
      }
      this._affectTheChange();
      this.fire('change',{
        taskId: this.taskId,
        lastTs: this.taskTs,
        plannedFor: this.plannedFor
      });
    },

    revert: function(){
      /*9
      if ( this._lastSaved ){
        this.selectedStartDate = new Date( this._lastSaved );
      }
      else{
        this.selectedStartDate = new Date( );
      }
      */

      console.log("reverting");
      this.set( "plannedFor", _.clone(this._lastSaved));
      console.log("plannedFor.kind set back to:", this.plannedFor);
      this._evaluate();
      return;

    },

    confirm: function(newTs){
      this._lastSaved = _.clone( this.plannedFor );
      this.set("taskTs", newTs);
      //console.log("taskTs set to ", newTs);
    },

    _affectTheChange: function(){

      var s = moment(this.selectedStartDate);
      var e = moment(this.selectedStartDate);
      s.hour(5).minute(30).second(0).millisecond(0);
      e.hour(18).minute(30).second(0).millisecond(0);
      /*
      console.log( "start",s.format("dddd, MMMM Do YYYY, h:mm:ss a") );
      console.log( "end",e.format("dddd, MMMM Do YYYY, h:mm:ss a") );
      */
      this.set("plannedFor.kind", "schedule");
      this.set("plannedFor.start", s.toDate() );
      this.set("plannedFor.end", e.toDate() );
      this.set("plannedFor", this.plannedFor);

      //console.log("plannedFor:", this.plannedFor);
      this._evaluate();
    },

    _evaluate: function(){
      this.mustSchedule=false; 
      this.isPlannedPast = false;
      this.isPlannedCurrent = false;
      this.isPlannedFuture = false;
      this.isAsap=false; 

      switch(this.plannedFor.kind){
        case "asap":
          this.isAsap=true; 
          this.set("okToStartTask",true);
          break;
        case "schedule":
          if ( 
            this.plannedFor.start && this.plannedFor.end
          ){
            //check if schedule is current
            if ( moment().isBefore(this.plannedFor.start) ){
              this.isPlannedFuture = true;
              this.set("okToStartTask",false);
            }
            else if ( moment().isAfter(this.plannedFor.end) ){
              this.isPlannedPast = true;
              this.set("okToStartTask",true);
            }
            else{
              this.isPlannedCurrent = true;
              this.set("okToStartTask",true);
            }
          }
          else{
            //no start date 
            this.mustSchedule=true; 
            this.set("okToStartTask",false);
          }
          break;
        default:
          this.isAsap=true; 
          this.set("okToStartTask",true);
          break;
      }

      if ( this.taskState==="done" ) this.set("okToStartTask",false);

    },

  });

</script>
