<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../moment-display/moment-import.html">
<link rel="import" href="../moment-display/moment-display.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-date-picker/paper-date-picker.html">
<link rel="import" href="dialog-assign.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <seed-element></seed-element>

@demo
-->
<dom-module id="task-part-timing">
  <style is="custom-style">

    .main {

    }
    .displaytxt {
      cursor: pointer;
      text-align: right;
      font-size: 14px;
      margin: 4px 4px 0 4px;
    }

    iron-icon {
      --iron-icon-width: 20px;
      --iron-icon-height: 20px;
      vertical-align: top;
    }

    .assignment {
      cursor: pointer;
      color: #00796B;
      font-size: .86em;
      font-weight: 400;
      text-align: right;
      padding-right: 4px;
      margin-right: 4px;
    }

    .current { 
      --label-color: #F4511E;
      --label-weight: 800;
      --display-color: #F4511E;
      --display-weight: 800;
    }

    .future{ 
      --label-color: #FF5722;
      --label-weight: 800;
      --display-color: #FF5722;
      --display-weight: 800;
    }

    .unscheduled {
      color: #D84315;
      font-weight: 800;
    }
    .asap, .overdue { 
      color: #BF360C;
      font-weight: 800;
    }

</style>

  <template>

    <div class="main"
    >
      <div class="displaytxt" on-click="openDatePicker">
        <span
         title="Task has no schedule date."
         hidden="[[!isAsap]]"
         class="asap"
         >
         ASAP
       </span>

        <moment-display
          hidden="[[!isPlannedPast]]"
          id="mdfuture"
          class="overdue"
          label="OVERDUE"
          inbound-fmt="YYYY-MM-DDThh:mm:ss"
          str="[[plannedFor.start]]"
        >
        </moment-display>

        <moment-display
          id="mdfuture"
          class="future"
          hidden="[[!isPlannedFuture]]"
          label="PLANNED"
          inbound-fmt="YYYY-MM-DDThh:mm:ss"
          str="[[plannedFor.start]]"
        >
        </moment-display>

        <moment-display
          id="mdcurrent"
          class="current"
          hidden="[[!isPlannedCurrent]]"
          label="PLANNED"
          inbound-fmt="YYYY-MM-DDThh:mm:ss"
          str="[[plannedFor.start]]"
        >
        </moment-display>

        <span
          hidden="[[!mustSchedule]]" 
          title="Task is unscheduled but scheduling is required. Click to schedule"
          class="unscheduled"
        >
          UNSCHEDULED
        </span>
        <moment-display
          id="mdtarget"
          class="unscheduled"
          hidden="[[!mustScheduleWithTarget]]"
          label="UNSCHEDULED"
          inbound-fmt="YYYY-MM-DDThh:mm:ss"
          str="[[plannedFor.target.start]]"
        ></moment-display>


        <!--<span>Test: [[selectedStartDate]]</span>-->
        <iron-icon icon="perm-contact-calendar"></iron-icon>
      </div>
      <div class='assignment' on-click="openAssignDialog">
        [[taskAssignedTo]]
      </div>
    </div>

    <dialog-assign
      id="dialogAssign"
      on-reassigned="gotTaskReAssigned"
    ></dialog-assign>

    <!--- DATEPICKER MODAL CONTENT -->
    <paper-dialog 
      id="dialog" class="paper-date-picker-dialog" 
      modal
      on-iron-overlay-closed="gotDismissDialog"
    >
      <paper-date-picker id="paperDatePicker"  date="{{selectedStartDate}}">
      </paper-date-picker>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>OK</paper-button>
      </div>
    </paper-dialog>


  </template>

</dom-module>

<script>
  Polymer({

    is: 'task-part-timing',
    properties: {
      taskId: {
        type: String
      },
      taskTs: {
        type: String,
        notify: true
      },
      taskAssignedTo: {
        type: String
      },
      plannedFor: {
        type: Object,
        value: null,
        notify: true
      },
      taskState: {
        type: Object,
        value: null
      },
      okToStart: { type: Boolean, value: false , notify: true },
      isAsap: { type: Boolean, value: false },
      mustSchedule: { type: Boolean, value: false },
      mustScheduleWithTarget: { type: Boolean, value: false },
      plannedPast: { type: Boolean, value: false },
      plannedCurrent: { type: Boolean, value: false },
      plannedFuture: { type: Boolean, value: false }

    },

    openAssignDialog: function(){
      if ( this.taskState=="init" ) {
        this.$.dialogAssign.show();
      }
    },

    attached: function(){

      //console.log(this.plannedFor.kind, this.selectedStartDate, this.plannedFor.start);
      this._lastSaved = _.clone(this.plannedFor);
      this._evaluate();
    },

    openDatePicker: function(){
      if ( this.taskState!=="init" ) {
        app.$.toast.text="You can not schedule tasks aready in progress or completed";
        app.$.toast.show();
        return;
      }
      this.$.dialog.open();
    },

    gotDismissDialog:function(closeEvent){
      console.log("gotDismissalDialog",closeEvent);

      if ( closeEvent.detail.confirmed !== true ){
        
        return;
      }
      this._affectTheChange();
      this.fire('change',{
        taskId: this.taskId,
        lastTs: this.taskTs,
        plannedFor: this.plannedFor
      });
    },

    revert: function(){
      this.set( "plannedFor", _.clone(this._lastSaved));
      this._evaluate();
      return;
    },

    gotTaskReAssigned: function(e,d){
      console.log("gotTaskReAssign",d);
      if ( this.taskAssignedTo!==d.reAssignTo ){
        this.fire('reassign',{
          taskId: this.taskId,
          lastTs: this.taskTs,
          assignTo: d.reAssignTo,
          lastAssignedTo: this.get("taskAssignedTo")
        });
        this.set("tmpReAssignTo", d.reAssignTo);
      }
    },

    confirmReAssign: function(newTs){
      this.set("taskTs", newTs);
      this.set("taskAssignedTo", this.get("tmpReAssignTo") );
    },

    confirm: function(newTs){
      this._lastSaved = _.clone( this.plannedFor );
      this.set("taskTs", newTs);
    },

    _affectTheChange: function(){

      var s = moment(this.selectedStartDate);
      var e = moment(this.selectedStartDate);
      s.hour(5).minute(30).second(0).millisecond(0);
      e.hour(18).minute(30).second(0).millisecond(0);
      /*
      console.log( "start",s.format("dddd, MMMM Do YYYY, h:mm:ss a") );
      console.log( "end",e.format("dddd, MMMM Do YYYY, h:mm:ss a") );
      */
      this.set("plannedFor.kind", "schedule");
      this.set("plannedFor.start", s.toDate() );
      this.set("plannedFor.end", e.toDate() );
      this.set("plannedFor", this.plannedFor);

      console.log("plannedFor has been set to:", this.plannedFor);
      this._evaluate(true);
    },

    _evaluate: function(skipSelectDateUpdate){
      this.mustSchedule=false; 
      this.mustScheduleWithTarget=false; 
      this.isPlannedPast = false;
      this.isPlannedCurrent = false;
      this.isPlannedFuture = false;
      this.isAsap=false; 
      var okToStart=false;
      switch(this.plannedFor.kind){
        case "asap":
          this.isAsap=true; 
          okToStart=true;
          break;
        case "schedule":
          if ( 
            this.plannedFor.start && this.plannedFor.end
          ){
            //check if schedule is current
            if ( moment().isBefore(this.plannedFor.start) ){
              this.isPlannedFuture = true;
              okToStart=false;
            }
            else if ( moment().isAfter(this.plannedFor.end) ){
              this.isPlannedPast = true;
              okToStart=true;
            }
            else{
              this.isPlannedCurrent = true;
              okToStart=true;
            }
            if ( skipSelectDateUpdate !== true ){
              var st_m = new moment(this.plannedFor.start.substr(0,19));
              st_m.add(st_m.utcOffset(),"m");
              console.log("selectedStartDate", st_m.toDate() );
              this.set("selectedStartDate", st_m.toDate() );
            }
          }
          else{
            //no start date 
            //console.log('no start date', this.plannedFor);
            if ( 
              _.get(this.plannedFor,'target.start',false)
            ){
              this.mustScheduleWithTarget=true; 
              this.mustSchedule=false; 
              if ( skipSelectDateUpdate !== true ){
                var st_m = new moment(this.plannedFor.target.start.substr(0,19));
                st_m.add(st_m.utcOffset(),"m");
                console.log("selectedStartDate", st_m.toDate() );
                this.set("selectedStartDate", st_m.toDate() );
              }
            }
            else this.mustSchedule=true; 
            okToStart=false;
          }
          break;
        default:
          this.isAsap=true; 
          okToStart=true;
          break;
      }

      if ( this.taskState==="done" || this.taskAssignedTo!==_.get(app,"scenariouser._id") ) {
        //console.log("not ok", this.taskAssignedTo);
        okToStart=false;
      }
      else {
        //console.log("is ok", this.taskAssignedTo);
      }
      
      
      this.$.mdcurrent.refresh();
      this.$.mdfuture.refresh();
      this.set("okToStart",okToStart);

    },

  });

</script>
